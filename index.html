<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Tic-Tac-Toe</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --accent-color: #ea4335;
            --light-color: #f8f9fa;
            --dark-color: #202124;
            --gray-color: #5f6368;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: var(--dark-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Auth Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: var(--light-color);
        }
        
        .auth-box {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .auth-title {
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .auth-input {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .auth-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .auth-button:hover {
            background-color: #3367d6;
        }
        
        .auth-divider {
            margin: 1.5rem 0;
            position: relative;
            text-align: center;
            color: var(--gray-color);
        }
        
        .auth-divider::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background-color: #ddd;
            z-index: -1;
        }
        
        .auth-divider span {
            background: white;
            padding: 0 1rem;
        }
        
        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: white;
            color: var(--gray-color);
            border: 1px solid #ddd;
            padding: 0.75rem;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .google-btn:hover {
            background-color: #f8f9fa;
        }
        
        .auth-footer {
            margin-top: 1.5rem;
            font-size: 0.9rem;
        }
        
        .auth-link {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .auth-link:hover {
            text-decoration: underline;
        }
        
        .error-message {
            color: var(--accent-color);
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        /* Game Styles */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            background-color: white;
            border-radius: 8px;
            margin: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 1rem;
        }
        
        .game-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .game-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .control-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .control-btn:hover {
            background-color: #f1f1f1;
        }
        
        .game-status {
            text-align: center;
            margin: 1rem 0;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
            aspect-ratio: 1/1;
        }
        
        .cell {
            background-color: var(--light-color);
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cell:hover {
            background-color: #e9e9e9;
        }
        
        .cell.x {
            color: var(--primary-color);
        }
        
        .cell.o {
            color: var(--secondary-color);
        }
        
        .cell.winner {
            background-color: rgba(66, 133, 244, 0.2);
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 300px;
            background-color: white;
            border-left: 1px solid #eee;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s;
        }
        
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-title {
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        
        .sidebar-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--gray-color);
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 1rem;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
        }
        
        /* Online Users */
        .online-users-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .user-item:hover {
            background-color: #f5f5f5;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #34a853;
        }
        
        .user-status.offline {
            background-color: #ea4335;
        }
        
        .invite-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .invite-btn:hover {
            background-color: #3367d6;
        }
        
        .invite-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* Chat Styles */
        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .message {
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .message.received {
            align-self: flex-start;
            background-color: #f1f1f1;
        }
        
        .message.sent {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
        }
        
        .message-sender {
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }
        
        .message-text {
            word-wrap: break-word;
        }
        
        .message-time {
            font-size: 0.7rem;
            text-align: right;
            opacity: 0.7;
            margin-top: 0.25rem;
        }
        
        .chat-input {
            display: flex;
            gap: 0.5rem;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        
        .chat-input-field {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .chat-send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0 1rem;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .chat-send-btn:hover {
            background-color: #3367d6;
        }
        
        /* Game History */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .history-item {
            padding: 0.75rem;
            border: 1px solid #eee;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .history-item:hover {
            background-color: #f5f5f5;
        }
        
        .history-opponent {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .history-result {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--gray-color);
        }
        
        .history-winner {
            color: var(--secondary-color);
            font-weight: bold;
        }
        
        .history-draw {
            color: var(--gray-color);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                width: 80%;
                max-width: 300px;
                transform: translateX(100%);
                z-index: 100;
                box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 99;
                display: none;
            }
            
            .overlay.open {
                display: block;
            }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div class="auth-container" id="authScreen">
        <div class="auth-box">
            <h1 class="auth-title">Online Tic-Tac-Toe</h1>
            <form class="auth-form" id="loginForm">
                <input type="email" class="auth-input" id="loginEmail" placeholder="Email" required>
                <input type="password" class="auth-input" id="loginPassword" placeholder="Password" required>
                <button type="submit" class="auth-button">Login</button>
                <div class="error-message" id="loginError"></div>
            </form>
            
            <div class="auth-divider"><span>OR</span></div>
            
            <button class="google-btn" id="googleLoginBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Sign in with Google
            </button>
            
            <div class="auth-footer">
                Don't have an account? <a href="#" class="auth-link" id="showRegister">Register</a>
            </div>
        </div>
        
        <div class="auth-box hidden" id="registerBox">
            <h1 class="auth-title">Create Account</h1>
            <form class="auth-form" id="registerForm">
                <input type="text" class="auth-input" id="registerName" placeholder="Name" required>
                <input type="email" class="auth-input" id="registerEmail" placeholder="Email" required>
                <input type="password" class="auth-input" id="registerPassword" placeholder="Password" minlength="6" required>
                <button type="submit" class="auth-button">Register</button>
                <div class="error-message" id="registerError"></div>
            </form>
            
            <div class="auth-footer">
                Already have an account? <a href="#" class="auth-link" id="showLogin">Login</a>
            </div>
        </div>
    </div>
    
    <!-- Game Screen -->
    <div class="container hidden" id="gameScreen">
        <div class="game-area">
            <div class="game-header">
                <h1 class="game-title">Tic-Tac-Toe</h1>
                <div class="game-controls">
                    <button class="control-btn" id="onlineUsersBtn" title="Online Players">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </button>
                    <button class="control-btn" id="chatBtn" title="Chat">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                    <button class="control-btn" id="historyBtn" title="Game History">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="game-status" id="gameStatus">Waiting for opponent...</div>
            
            <div class="game-board" id="gameBoard">
                <div class="cell" data-index="0"></div>
                <div class="cell" data-index="1"></div>
                <div class="cell" data-index="2"></div>
                <div class="cell" data-index="3"></div>
                <div class="cell" data-index="4"></div>
                <div class="cell" data-index="5"></div>
                <div class="cell" data-index="6"></div>
                <div class="cell" data-index="7"></div>
                <div class="cell" data-index="8"></div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title" id="sidebarTitle">Online Players</h2>
                <button class="sidebar-close" id="sidebarClose">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="sidebar-content">
                <div class="tabs">
                    <div class="tab active" data-tab="online">Online</div>
                    <div class="tab" data-tab="chat">Chat</div>
                    <div class="tab" data-tab="history">History</div>
                </div>
                
                <div class="tab-content active" data-tab-content="online">
                    <div class="online-users-list" id="onlineUsersList"></div>
                </div>
                
                <div class="tab-content" data-tab-content="chat">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input">
                        <input type="text" class="chat-input-field" id="chatInput" placeholder="Type your message...">
                        <button class="chat-send-btn" id="chatSendBtn">Send</button>
                    </div>
                </div>
                
                <div class="tab-content" data-tab-content="history">
                    <div class="history-list" id="historyList"></div>
                </div>
            </div>
        </div>
        
        <div class="overlay" id="overlay"></div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB85H7SaqfcOQWTlWQUzvtawto4pi9Rr_Y",
            authDomain: "tictactoe-5e57d.firebaseapp.com",
            projectId: "tictactoe-5e57d",
            storageBucket: "tictactoe-5e57d.firebasestorage.app",
            messagingSenderId: "1035924406511",
            appId: "1:1035924406511:web:12bd3b85d0995e1a1b5b1a",
            measurementId: "G-XBTT8GBHL3",
            databaseURL: "https://tictactoe-5e57d-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // DOM Elements
        const authScreen = document.getElementById('authScreen');
        const gameScreen = document.getElementById('gameScreen');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const registerBox = document.getElementById('registerBox');
        const loginError = document.getElementById('loginError');
        const registerError = document.getElementById('registerError');
        
        const gameBoard = document.getElementById('gameBoard');
        const gameStatus = document.getElementById('gameStatus');
        const onlineUsersBtn = document.getElementById('onlineUsersBtn');
        const chatBtn = document.getElementById('chatBtn');
        const historyBtn = document.getElementById('historyBtn');
        
        const sidebar = document.getElementById('sidebar');
        const sidebarTitle = document.getElementById('sidebarTitle');
        const sidebarClose = document.getElementById('sidebarClose');
        const overlay = document.getElementById('overlay');
        
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        const onlineUsersList = document.getElementById('onlineUsersList');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const historyList = document.getElementById('historyList');

        // Game State
        let currentUser = null;
        let currentGame = null;
        let currentPlayer = null;
        let gameRef = null;
        let usersRef = null;
        let invitesRef = null;
        let messagesRef = null;
        let userGamesRef = null;
        let gameResultsRef = null;
        let onlineUsers = {};

        // Initialize the application
        function init() {
            setupEventListeners();
            checkAuthState();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Auth events
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            googleLoginBtn.addEventListener('click', handleGoogleLogin);
            showRegister.addEventListener('click', showRegisterForm);
            showLogin.addEventListener('click', showLoginForm);
            
            // Game events
            gameBoard.addEventListener('click', handleCellClick);
            onlineUsersBtn.addEventListener('click', () => showSidebar('online'));
            chatBtn.addEventListener('click', () => showSidebar('chat'));
            historyBtn.addEventListener('click', () => showSidebar('history'));
            sidebarClose.addEventListener('click', hideSidebar);
            overlay.addEventListener('click', hideSidebar);
            
            // Tab events
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Chat events
            chatSendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // Check authentication state
        function checkAuthState() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    setupUser(user);
                    authScreen.classList.add('hidden');
                    gameScreen.classList.remove('hidden');
                    initializeGame();
                } else {
                    currentUser = null;
                    authScreen.classList.remove('hidden');
                    gameScreen.classList.add('hidden');
                }
            });
        }

        // Handle email/password login
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    loginError.textContent = '';
                })
                .catch(error => {
                    loginError.textContent = error.message;
                });
        }

        // Handle registration
        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Save additional user info
                    return userCredential.user.updateProfile({
                        displayName: name
                    });
                })
                .then(() => {
                    registerError.textContent = '';
                    showLoginForm();
                })
                .catch(error => {
                    registerError.textContent = error.message;
                });
        }

        // Handle Google login
        function handleGoogleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch(error => {
                    loginError.textContent = error.message;
                });
        }

        // Show registration form
        function showRegisterForm(e) {
            e.preventDefault();
            loginForm.closest('.auth-box').classList.add('hidden');
            registerBox.classList.remove('hidden');
        }

        // Show login form
        function showLoginForm(e) {
            if (e) e.preventDefault();
            registerBox.classList.add('hidden');
            loginForm.closest('.auth-box').classList.remove('hidden');
        }

        // Set up user in database
        function setupUser(user) {
            usersRef = database.ref('users/' + user.uid);
            
            // Update user info in database
            const userData = {
                email: user.email,
                displayName: user.displayName || user.email.split('@')[0],
                online: true,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            };
            
            usersRef.update(userData);
            
            // Set user offline when they disconnect
            usersRef.onDisconnect().update({
                online: false,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
        }

        // Initialize game
        function initializeGame() {
            // Initialize database references
            invitesRef = database.ref('gameInvites/' + currentUser.uid);
            messagesRef = database.ref('messages');
            userGamesRef = database.ref('userGames/' + currentUser.uid);
            gameResultsRef = database.ref('gameResults');
            
            // Listen for invites
            invitesRef.on('child_added', handleNewInvite);
            
            // Listen for online users
            database.ref('users').on('value', (snapshot) => {
                onlineUsers = snapshot.val() || {};
                updateOnlineUsersList();
            });
            
            // Listen for chat messages
            messagesRef.limitToLast(20).on('child_added', (snapshot) => {
                addMessageToChat(snapshot.val());
            });
            
            // Load game history
            loadGameHistory();
        }

        // Handle new game invite
        function handleNewInvite(snapshot) {
            const invite = snapshot.val();
            const inviteId = snapshot.key;
            
            if (confirm(`${invite.fromEmail} wants to play with you. Accept?`)) {
                // Create new game
                createNewGame(invite.fromUserId);
                
                // Remove the invite
                invitesRef.child(inviteId).remove();
            } else {
                // Reject the invite
                invitesRef.child(inviteId).remove();
            }
        }

        // Create new game
        function createNewGame(opponentId) {
            const gameRef = database.ref('games').push();
            const gameId = gameRef.key;
            
            const gameData = {
                playerX: currentUser.uid,
                playerO: opponentId,
                board: ['', '', '', '', '', '', '', '', ''],
                currentPlayer: 'X',
                status: 'waiting',
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            gameRef.set(gameData).then(() => {
                // Add game to both players' game lists
                database.ref('userGames/' + currentUser.uid + '/' + gameId).set(true);
                database.ref('userGames/' + opponentId + '/' + gameId).set(true);
                
                // Start listening to game updates
                listenToGame(gameRef);
            });
        }

        // Listen to game updates
        function listenToGame(ref) {
            // If already listening to a game, stop listening
            if (gameRef) {
                gameRef.off();
            }
            
            gameRef = ref;
            
            ref.on('value', (snapshot) => {
                const game = snapshot.val();
                currentGame = game;
                
                if (!game) {
                    // Game was deleted
                    gameStatus.textContent = 'Game ended';
                    resetBoard();
                    return;
                }
                
                // Update game status
                if (game.status === 'waiting') {
                    gameStatus.textContent = 'Waiting for opponent...';
                } else if (game.status === 'in-progress') {
                    const isPlayerX = game.playerX === currentUser.uid;
                    const isPlayerO = game.playerO === currentUser.uid;
                    
                    if (isPlayerX && game.currentPlayer === 'X') {
                        gameStatus.textContent = 'Your turn (X)';
                        currentPlayer = 'X';
                    } else if (isPlayerO && game.currentPlayer === 'O') {
                        gameStatus.textContent = 'Your turn (O)';
                        currentPlayer = 'O';
                    } else {
                        gameStatus.textContent = `Waiting for ${game.currentPlayer}'s move`;
                        currentPlayer = null;
                    }
                } else if (game.status === 'finished') {
                    if (game.winner === 'draw') {
                        gameStatus.textContent = 'Game ended in a draw!';
                    } else {
                        const isWinner = (game.winner === 'X' && game.playerX === currentUser.uid) || 
                                        (game.winner === 'O' && game.playerO === currentUser.uid);
                        gameStatus.textContent = isWinner ? 'You won!' : 'You lost!';
                    }
                    
                    // Save game result
                    saveGameResult(game);
                    
                    // Stop listening after a delay
                    setTimeout(() => {
                        ref.off();
                        gameRef = null;
                        currentGame = null;
                    }, 3000);
                }
                
                // Update board
                updateBoard(game.board, game.winningCells);
            });
        }

        // Update game board
        function updateBoard(board, winningCells = []) {
            const cells = document.querySelectorAll('.cell');
            
            cells.forEach((cell, index) => {
                cell.textContent = board[index] || '';
                cell.className = 'cell';
                
                if (board[index] === 'X') {
                    cell.classList.add('x');
                } else if (board[index] === 'O') {
                    cell.classList.add('o');
                }
                
                if (winningCells && winningCells.includes(index)) {
                    cell.classList.add('winner');
                }
            });
        }

        // Reset board
        function resetBoard() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                cell.textContent = '';
                cell.className = 'cell';
            });
            
            gameStatus.textContent = 'Waiting for opponent...';
            currentPlayer = null;
        }

        // Handle cell click
        function handleCellClick(e) {
            if (!currentGame || currentGame.status !== 'in-progress' || !currentPlayer) return;
            
            const cellIndex = parseInt(e.target.getAttribute('data-index'));
            
            // Check if cell is empty
            if (currentGame.board[cellIndex] !== '') return;
            
            // Make move
            const newBoard = [...currentGame.board];
            newBoard[cellIndex] = currentPlayer;
            
            // Check for winner
            const winner = checkWinner(newBoard, currentPlayer);
            const winningCells = winner ? getWinningCells(newBoard, currentPlayer) : null;
            
            // Check for draw
            const isDraw = !winner && newBoard.every(cell => cell !== '');
            
            // Update game state
            const updates = {
                board: newBoard,
                currentPlayer: currentPlayer === 'X' ? 'O' : 'X'
            };
            
            if (winner) {
                updates.status = 'finished';
                updates.winner = currentPlayer;
                updates.winningCells = winningCells;
            } else if (isDraw) {
                updates.status = 'finished';
                updates.winner = 'draw';
            } else if (currentGame.status === 'waiting') {
                updates.status = 'in-progress';
            }
            
            gameRef.update(updates);
        }

        // Check for winner
        function checkWinner(board, player) {
            const winningCombinations = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
                [0, 4, 8], [2, 4, 6]             // diagonals
            ];
            
            return winningCombinations.some(combination => {
                return combination.every(index => board[index] === player);
            });
        }

        // Get winning cells
        function getWinningCells(board, player) {
            const winningCombinations = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
                [0, 4, 8], [2, 4, 6]             // diagonals
            ];
            
            const winningCombo = winningCombinations.find(combination => {
                return combination.every(index => board[index] === player);
            });
            
            return winningCombo || [];
        }

        // Save game result
        function saveGameResult(game) {
            const resultRef = gameResultsRef.child(gameRef.key);
            
            const resultData = {
                playerX: game.playerX,
                playerO: game.playerO,
                winner: game.winner,
                board: game.board,
                endedAt: firebase.database.ServerValue.TIMESTAMP,
                winningCells: game.winningCells || []
            };
            
            resultRef.set(resultData);
        }

        // Load game history
        function loadGameHistory() {
            userGamesRef.on('value', (snapshot) => {
                const gameIds = snapshot.val() || {};
                const gamePromises = Object.keys(gameIds).map(gameId => {
                    return database.ref('gameResults/' + gameId).once('value');
                });
                
                Promise.all(gamePromises).then(snapshots => {
                    const historyItems = snapshots
                        .filter(snapshot => snapshot.exists())
                        .map(snapshot => {
                            const game = snapshot.val();
                            return {
                                id: snapshot.key,
                                ...game
                            };
                        })
                        .sort((a, b) => b.endedAt - a.endedAt);
                    
                    renderHistoryList(historyItems);
                });
            });
        }

        // Render history list
        function renderHistoryList(historyItems) {
            historyList.innerHTML = '';
            
            historyItems.forEach(item => {
                const isPlayerX = item.playerX === currentUser.uid;
                const opponentId = isPlayerX ? item.playerO : item.playerX;
                const opponent = onlineUsers[opponentId] || { displayName: 'Unknown', email: 'unknown' };
                
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-opponent">${opponent.displayName || opponent.email}</div>
                    <div class="history-result">
                        <span>${new Date(item.endedAt).toLocaleString()}</span>
                        ${item.winner === 'draw' ? 
                            '<span class="history-draw">Draw</span>' : 
                            `<span class="history-winner">${item.winner === (isPlayerX ? 'X' : 'O') ? 'Won' : 'Lost'}</span>`
                        }
                    </div>
                `;
                
                historyItem.addEventListener('click', () => {
                    showGameResult(item);
                });
                
                historyList.appendChild(historyItem);
            });
        }

        // Show game result
        function showGameResult(game) {
            alert(`Game against ${onlineUsers[game.playerX === currentUser.uid ? game.playerO : game.playerX]?.displayName || 'Unknown'} 
                \nResult: ${game.winner === 'draw' ? 'Draw' : `Winner: ${game.winner}`}
                \nEnded at: ${new Date(game.endedAt).toLocaleString()}`);
        }

        // Update online users list
        function updateOnlineUsersList() {
            onlineUsersList.innerHTML = '';
            
            Object.entries(onlineUsers).forEach(([userId, user]) => {
                if (userId === currentUser.uid || !user.online) return;
                
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar">${user.displayName ? user.displayName.charAt(0).toUpperCase() : '?'}</div>
                        <div>${user.displayName || user.email}</div>
                        <div class="user-status ${user.online ? '' : 'offline'}"></div>
                    </div>
                    <button class="invite-btn" data-user-id="${userId}" ${currentGame ? 'disabled' : ''}>
                        Invite
                    </button>
                `;
                
                onlineUsersList.appendChild(userItem);
            });
            
            // Add event listeners to invite buttons
            document.querySelectorAll('.invite-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = e.target.getAttribute('data-user-id');
                    sendGameInvite(userId);
                });
            });
        }

        // Send game invite
        function sendGameInvite(userId) {
            const inviteRef = database.ref('gameInvites/' + userId).push();
            
            const inviteData = {
                fromUserId: currentUser.uid,
                fromEmail: currentUser.email,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            inviteRef.set(inviteData)
                .then(() => {
                    alert('Invite sent!');
                })
                .catch(error => {
                    alert('Failed to send invite: ' + error.message);
                });
        }

        // Add message to chat
        function addMessageToChat(message) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.userId === currentUser.uid ? 'sent' : 'received'}`;
            messageElement.innerHTML = `
                <div class="message-sender">${message.email}</div>
                <div class="message-text">${message.text}</div>
                <div class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</div>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message
        function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;
            
            const message = {
                userId: currentUser.uid,
                email: currentUser.email,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            messagesRef.push(message)
                .then(() => {
                    chatInput.value = '';
                })
                .catch(error => {
                    alert('Failed to send message: ' + error.message);
                });
        }

        // Show sidebar
        function showSidebar(tab) {
            sidebar.classList.add('open');
            overlay.classList.add('open');
            switchTab(tab);
        }

        // Hide sidebar
        function hideSidebar() {
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        }

        // Switch tab
        function switchTab(tabName) {
            // Update active tab
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update active tab content
            tabContents.forEach(content => {
                if (content.getAttribute('data-tab-content') === tabName) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Update sidebar title
            switch(tabName) {
                case 'online':
                    sidebarTitle.textContent = 'Online Players';
                    break;
                case 'chat':
                    sidebarTitle.textContent = 'Chat';
                    break;
                case 'history':
                    sidebarTitle.textContent = 'Game History';
                    break;
            }
        }

        // Initialize the app
        init();
    </script>
</body>
</html>